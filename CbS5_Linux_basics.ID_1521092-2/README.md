# Защита последнего сервера Linux в мире
Аннотация: данный проект позволит тебе познакомиться с операционной системой Linux и принципами обеспечения ее безопасности. Кроме того, ты подготовишь для себя инструменты, которые точно пригодятся в будущей профессии.

## Содержание
1. [Chapter I](#chapter-i) \
   1.1. [Рекомендации к проекту](#рекомендации-к-проекту)
2. [Chapter II](#chapter-ii) \
   2.1. [ОС Linux](#ос-linux)
3. [Chapter III](#chapter-iii) \
   3.1. [Задание 1. Создание скрипта сбора информации о дистрибутиве](#задание-1-создание-скрипта-сбора-информации-о-дистрибутиве) \
   3.2. [Задание 2. Создание скрипта настройки Linux](#задание-2-создание-скрипта-настройки-linux) \
   3.3. [Задание 3. Настройка мониторинга Linux](#задание-3-настройка-мониторинга-linux) \
   3.4. [Задание 4. Защита операционной системы встроенными инструментами](#задание-4-защита-операционной-системы-встроенными-инструментами) 

### Введение

>Шел 2121 год, Skynet практически полностью поработила всё человечество, и только небольшая группа людей не оставляет попытки сопротивляться, устроив свою базу под землей. Чтобы уничтожить бездушную машину, которая не способна даже написать симфонию, необходимо подобрать секретный код от пульта управления, поэтому выжившие решают собрать сервер для подбора секретного ключа с использованием видеокарт, которые удастся найти на поверхности. В результате вылазки на опустевшие улицы города из найденных запчастей им удалось собрать сервер, но в найденной на поверхности флешке был только образ операционной системы Linux. Ты единственный, кто из всех присутствующих умеет запускать командную строку, поэтому разворачивать сервер придется именно тебе.

## Chapter I
### Рекомендации к проекту
Как учиться в «Школе 21»:  
- На протяжении всего курса ты будешь самостоятельно добывать информацию. Пользуйся всеми доступными средствами поиска информации, к примеру, Google и GigaChat. Будь внимателен к источникам информации: проверяй, думай, анализируй, сравнивай. 
- Взаимообучение (P2P, Peer-to-Peer) — это процесс, при котором учащиеся обмениваются знаниями и опытом, выступая одновременно в роли учителей и учеников. Этот подход позволяет учиться не только у преподавателя, но и друг у друга, что способствует более глубокому пониманию материала.
- Не стесняйся просить помощи: вокруг тебя такие же пиры, которые тоже проходят этот путь впервые. Не бойся откликаться на просьбы о помощи. Твой опыт ценен и полезен, смело делись им с другими участниками. 
- Не списывай, а если пользуешься помощью — всегда разбирайся до конца, почему, как и зачем. Иначе твое обучение не будет иметь никакого смысла. 
- Если ты на чем-то застрял и кажется, что ты уже все перепробовал, но все равно непонятно, куда идти, — просто передохни! Поверь, этот совет помогал многим экспертам по КБ в их работе. Проветрись, перезагрузи голову и, возможно, в следующий раз тебе наконец придет нужное решение!
- Важен не только результат обучения, но и сам процесс. Нужно не просто решить задачу, а понять, КАК ее решить.
- На пути к мастерству в сфере кибербезопасности ты получаешь возможность быть частью поддерживающего и вдохновляющего сообщества «Школы 21» по Кибербезопасности. Присоединяйся в [RocketChat](https://rocketchat-student.21-school.ru/channel/cybersec_21), чтобы получать свежие анонсы от сообщества, а также вступай в [Telegram](https://t.me/+r5wufz8L3mUzOGUy) для коммуникации.

Как работать с проектом: 
- Перед выполнением проект необходимо склонировать с GitLab в одноименный репозиторий.
- Все файлы с кодом необходимо создавать в папке src склонированного репозитория.
- После клонирования проекта необходимо создать ветку `develop` и вести разработку в ней. После этого пушить в GitLab также нужно ветку `develop`.
- В твоей директории не должно быть иных файлов, кроме тех, что обозначены в заданиях.
- Перед выполнением проекта ознакомься с инструкцией по установке виртуальной машины Linux с использованием Virtual Box в директории `materials`. 

Дисклеймер: 
- В целях геймификации обучения проект подается в формате истории, чтобы у тебя была возможность отвлечься от сложных заданий и тонны теории в гугле. Если придуманная история кажется тебе бесталанной и скучной, можно указать на это в обратной связи, чтобы автор поплакал над своим писательским навыком. Также можно пропускать введение в каждом задании и фокусироваться только на содержательной части.

## Chapter II
### ОС Linux

Linux — это операционная система семейства Unix, которая базируется на ядре с одноименным названием. Исходный код можно посмотреть своими глазами в [открытом репозитории](https://github.com/torvalds/linux).

Дистрибутив Linux — это один из «подвидов» ОС Linux. Отличаются они как наполнением (разный софт, библиотеки, инструменты), так и внешне (графические интерфейсы). В кибербезопасности самым популярным дистрибутивом является Kali Linux в силу своей специфической направленности на ИБ. Именно его тебе необходимо развернуть перед тем, как приступать к заданиям (см. инструкцию).

«Изучить» Linux невозможно, но можно приблизиться к данному знанию максимально, если на постоянной основе пользоваться этой ОС. Ты будешь сталкиваться с ошибками, которые ни у кого в мире больше не возникали, будут постоянные проблемы с поиском нужных форумов и пересобиранием программ из исходников, однако это единственный способ разобраться и больше не бояться терминала Linux. Оно того стоит (но это не точно). Результат выполненных тобой практических заданий ты сможешь затем использовать в работе или на своем домашнем линуксе.

---

В качестве разминки перед первым заданием тебе нужно суметь ответить на следующие вопросы о Linux:
- Что такое bash?
- Где находится корень в файловой системе Linux?
- Почему команду rm -rf / ни в коем случае нельзя вводить в терминале? (Это не шутка, не пробуй.)
- Как, находясь в терминале, попасть из одной директории в другую?

После короткого квиза можно копнуть немного глубже и начать изучать следующие полезные ресурсы:

- Linux Bible, Christopher Negus;
- Linux Mastery: 100+ Exercises for Building Your Skills, Frank Anemaet;
- https://www.linuxfoundation.org/blog/blog/classic-sysadmin-the-linux-filesystem-explained.

---

## Chapter III
### Задание 1. Создание скрипта сбора информации о дистрибутиве
Для решения данного задания нужны знания в следующих темах: bash, основные команды в терминале.

>Ты развернул сервер и установил Linux с флешки. Долгожданный терминал, и... К сожалению, это не Ubuntu. Задача усложнилась многократно. Теперь тебе нужно собрать информацию о найденном дистрибутиве, чтобы понять, с чем ты имеешь дело. Иначе все надежды человечества будут погребены под одной неправильно введенной командой.

В Linux-терминале есть некий «свод» правил, который поможет тебе освоиться в новых условиях.

1. ~~Никому не рассказывать о бойцовском клу~~
1. Практически любая команда содержит опцию --help. Например, если ты забыл, что выполняет «cd», всегда можно ввести:

    ```
    cd --help
    ```
    И ты увидишь подсказки и возможные опции к любой команде. Альтернативой является man:
  
    ```
    > man cp
    ```

2. Если не знаешь, что делает команда — не вводи! Особенно это касается выполнения команд от root пользователя.
3. При рутинном использовании Linux всегда выбирай пользователя с обычными правами, а не привилегированного. Так ты убережешь себя от лишних проблем, которые сам себе и создашь, если будешь всё выполнять от root. Аргумент «Мне надоело вводить каждый раз пароль при запуске команд» не принимается. Особенно отделом ИБ.

Терминал — это оболочка, которая используется в любом дистрибутиве. Разница в том, что оболочки бывают разные (ksh, zsh, bash). Самая распространенная — bash. Она может использоваться как интерпретатор команд в терминале, а также как язык для написания скриптов. Рекомендуем освоить именно ее.

**Твоя задача**: написать bash-скрипт с названием `get_all_info.sh`, который при запуске от root будет собирать следующую информацию о системе:

1. Установленные пакеты.
1. Запущенные процессы.
1. Открытые порты.
1. Устанавливать с помощью пакетного менеджера пакеты «cowsay» и «sl» (в 2010-х эти пакеты были «мемными» среди сисадминов и хакеров). 
1. Версию ядра и операционной системы. 
1. Записывать вышеописанную информацию в файл `info` и сжимать его в архив `OS_RESULT.tar`.

В результате выполнения этого задания у тебя должны быть:
- архив `OS_RESULT.tar` с файлом `info` внутри; 
- bash-скрипт, в котором содержатся необходимые для выполнения вышеописанных пунктов команды и bash-конструкции. Он поможет тебе и в работе, когда нужно будет работать с новым Linux-устройством — так ты сможешь быстро получить всю основную информацию о том, что происходит в системе с сетью, процессами и пакетами.

### Задание 2. Создание скрипта настройки Linux
Для решения данного задания нужны знания в следующих темах: bash, DAC, apt, создание/удаление пользователей и групп.

>Все в восторге! Теперь у выживших есть сервер, который осталось всего лишь настроить, подключить видеокарты и начать возвращать человечество на вершину цепочки эволюции. Было бы просто замечательно, имей ты под рукой готовый скрипт для настройки операционной системы... Тогда бы не пришлось вводить все эти команды самостоятельно :(

В Linux, как и в любой другой системе, есть механизм контроля доступа. Это нужно, чтобы пользователь А не мог скачать фотки с отпуска пользователя Б, если они пользуются одним устройством. В большинстве систем по умолчанию реализована DAC (Discretionary Access Control). Это значит, что любой файл имеет своего владельца-пользователя (того, кто создал этот файл), владельца-группу (это группа, в которой состоит владелец-пользователь) и значения прав доступа (rwx — Read, Write, eXecute). Рекомендуем почитать про MAC и RBAC механизмы контроля доступа. Они в 90% случаев также имплементируются в дистрибутивы с помощью, например, Selinux или AppArmor.

Поэтому, когда ты создаешь нового пользователя, ты должен учесть, что у него должна быть группа (она создается автоматически, если не указано обратное). Создание новых пользователей — частое явление на практике. Создание новых групп — менее частое. При этом некоторые пакеты, например, docker, тоже создают себе отдельную группу.

**Твоя задача**: создать bash-скрипт, в котором будут создаваться пользователи и группы, но с одним условием: их права должны быть ограничены их функциональными задачами.

1. Создай пользователя user и группу default_users с правами по умолчанию.
2. Создай пользователей secret_agent, secret_spy, secret_boss, все они должны быть в группе secret_users.
3. Пользователи группы secret_users должны иметь возможность получать доступ к домашним директориям друг друга. Остальные — нет.
4. Сделай директорию /var доступной любым пользователям и любым группам.
5. Установи пакет apache2 и проверь состояние linux-сервиса apache2 после установки.
6. Пользователи группы default_users должны иметь возможность вводить все команды от sudo без ввода пароля.

В результате выполнения этой задачи у тебя должен быть скрипт с расширением .sh (название скрипта — любое).

_Примечание_: для проверки работоспособности скрипт нужно запускать от root, поскольку должны выполняться команды, требующие повышенных привилегий.

**Подсказка**: для решения 3 и 4 задачи поможет утилита chmod. Для задачи 6 тебе нужен файл `/etc/sudoers`.

### Задание 3. Настройка мониторинга Linux
Для решения данного задания нужны знания в следующих темах: почтовые сервера (postfix), bash, планировщик задач (cron), прокси, smtp, imap, pop3.

>После тщательной настройки ты понимаешь, что нужно постоянно отслеживать состояние сервера, ведь он буквально собран из мусора. Работа по расшифровке должна идти беспрерывно, поэтому ты настраиваешь мониторинг системы в автоматическом режиме.

Мониторинг Linux-систем в корпоративных сетях, конечно же, осуществляется с помощью отдельных систем, как правило, лицензированных и дорогих. Однако существуют и штатные средства, которые могут быть использованы как один из «дёшево и сердито» вариантов. Для этого нужно установить пакет logwatch.

Чтобы не заходить каждый раз на устройство, ты можешь настроить отправление нужной тебе информации на любой другой сервис. Например, тебе на личную почту. Для этого подойдёт почтовый сервер Postfix и штатный планировщик — crontab. Postfix позволяет как принимать письма, так и отправлять их.

**Твоя задача**: настроить автоматическую отправку логов за предыдущий день с помощью logwatch, postfix и crontab на свою почту: gmail/yandex/mail каждые сутки в 00:00. Детализация логов должна быть максимальной.

В результате выполнения задачи ты будешь получать на почту каждые сутки отчет о состоянии своей системы. В репозиторий необходимо загрузить:
- конфигурационный файл `postfix main.cf`;
- файл `cron.txt`, содержащий строку конфигурации планировщика (например, «12 40 * * * ...»).

### Задание 4. Защита операционной системы встроенными инструментами
Для решения данного задания нужны знания в следующих темах: iptables, ssh, private/public key.

>— Хьюстон, у нас проблемы! — послышалось в одной из комнат бункера. 
>
>Ты заходишь в импровизированный дата-центр с вашим единственным сервером. Мужчина, который только благодаря наличию очков был назначен смотрителем, дрожащей рукой показывает на монитор. На нем видны логи, по которым ты сразу понимаешь, что Skynet вычислил вас по IP! И прямо в данный момент проводит атаку на ваш сервер. Нужно срочно что-то сделать...

Встроенные средства защиты Linux позволяют достаточно неплохо обезопасить твою систему разными способами. Ранее упомянутые SELinux и AppArmor защищают твою систему с помощью прав доступа. Iptables защищает сетевые соединения, позволяя тебе блокировать сетевые пакеты с определенными параметрами или закрывать порты. Системы IDS и IPS обнаруживают и предотвращают вторжения. Рекомендуем почитать про Snort и Suricata, их принципы работы и правила обнаружения сигнатур.

Безопасность всегда должна быть комплексной, поэтому ты всегда должен помнить про безопасность сервисов и ПО, которые работают на твоем устройстве. Если установлен веб-сервер, он должен быть безопасно настроен в соответствии с требованиями. Если установлен SSH, он также должен быть настроен безопасно. 

**Твоя задача**: 
1. Настрой подключение к своему Linux по SSH с использованием приватного и публичного ключей, а не пароля. 
2. Запрети подключаться к своему устройству по порту 80/tcp извне.

В качестве ответа загрузи в репозиторий:
- файл конфигурации `sshd_config` своей виртуальной машины, к которой нужно подключаться;
- файл `authorized_keys`;
- файл `iptables.txt`, в котором содержится вывод одной цепочки iptables правил на устройстве (цепочка должна быть та, куда было записано правило).

_Подсказка_: для решения задания 2 тебе нужно использовать цепочку INPUT в iptables.

💡 Нажми [сюда](https://new.oprosso.net/p/4cb31ec3f47a4596bc758ea1861fb624), чтобы поделиться с нами обратной связью на этот проект. Это анонимно и поможет команде Продукта сделать твоё обучение лучше.
