# Основы сетей. Часть 3 — «Продвинутый сетевой детектив»
Аннотация: в этом проекте тебе предстоит создать несколько сетевых топологий с продвинутыми настройками в каждой. Ты поработаешь с «фичами» Cisco-оборудования, затронешь не только маршрутизаторы, но и коммутаторы. Научишься делать «резервные» каналы маршрутизации и соединять разные подсети в одну виртуальную.

## Содержание
1. [Chapter I](#chapter-i) \
   1.1. [Рекомендации к проекту](#рекомендации-к-проекту)
2. [Chapter II](#chapter-ii) \
   2.1. [Основы сетей. Часть 3](#основы-сетей-часть-3)
3. [Chapter III](#chapter-iii) \
   3.1. [Задание 1. Виртуальные сети](#задание-1-виртуальные-сети) \
   3.2. [Задание 2. Расширение канала](#задание-2-расширение-канала) \
   3.3. [Задание 3. Динамическая маршрутизация](#задание-3-динамическая-маршрутизация) \
   3.4. [Задание 4. Резервирование](#задание-4-резервирование) 


#### Введение
>Ночь. Улица. Фонарь. Аптека.
>
>Иван был измотан ночной работой, поэтому решил зайти в Горздрав за очередной пачкой снотворного. Мысли об увольнении не покидали его уже вторую неделю, но решиться написать рапорт он до сих пор не смог. У самой кассы, пока за прилавком сонная девчушка лет двадцати пересчитывала сдачу, его телефон завибрировал в кармане. Это был Митя Карамазов — начальник отдела, который отличался одиозностью и несговорчивостью. Все знали, что он проходил подозреваемым по делу об убийстве своего отца, но позже это обвинение было снято. Иван всегда задавался вопросом, как его взяли в органы после такого громкого дела.
>
>— Ваня, у нас срочное дело. Нужна твоя смекалка — задача нетривиальная. Подбирай напарника на маршала Жукова, 15 и поезжай к месту преступления, детали скину смской.

## Chapter I
### Рекомендации к проекту
Как учиться в «Школе 21»:  
- На протяжении всего курса ты будешь самостоятельно добывать информацию. Пользуйся всеми доступными средствами поиска информации, к примеру, Google и GigaChat. Будь внимателен к источникам информации: проверяй, думай, анализируй, сравнивай. 
- Взаимообучение (P2P, Peer-to-Peer) — это процесс, при котором учащиеся обмениваются знаниями и опытом, выступая одновременно в роли учителей и учеников. Этот подход позволяет учиться не только у преподавателя, но и друг у друга, что способствует более глубокому пониманию материала.
- Не стесняйся просить помощи: вокруг тебя такие же пиры, которые тоже проходят этот путь впервые. Не бойся откликаться на просьбы о помощи. Твой опыт ценен и полезен, смело делись им с другими участниками. 
- Не списывай, а если пользуешься помощью — всегда разбирайся до конца, почему, как и зачем. Иначе твое обучение не будет иметь никакого смысла. 
- Если ты на чем-то застрял и кажется, что ты уже все перепробовал, но все равно непонятно, куда идти, — просто передохни! Поверь, этот совет помогал многим экспертам по КБ в их работе. Проветрись, перезагрузи голову и, возможно, в следующий раз тебе наконец придет нужное решение!
- Важен не только результат обучения, но и сам процесс. Нужно не просто решить задачу, а понять, КАК ее решить.

Как работать с проектом: 
- Перед выполнением проект необходимо склонировать с GitLab в одноименный репозиторий.
- Все файлы с кодом необходимо создавать в папке src склонированного репозитория.
- После клонирования проекта необходимо создать ветку `develop` и вести разработку в ней. После этого пушить в GitLab также нужно ветку `develop`.
- В твоей директории не должно быть иных файлов, кроме тех, что обозначены в заданиях.
- На пути к мастерству в сфере кибербезопасности ты получаешь возможность быть частью поддерживающего и вдохновляющего сообщества «Школы 21» по Кибербезопасности. Присоединяйся в [RocketChat](https://rocketchat-student.21-school.ru/channel/cybersec_21), чтобы получать свежие анонсы от сообщества, а также вступай в [Telegram](https://t.me/+r5wufz8L3mUzOGUy) для коммуникации. 

Дисклеймер: 
- В целях геймификации обучения проект подается в формате истории, чтобы у тебя была возможность отвлечься от сложных заданий и тонны теории в гугле. Если придуманная история кажется тебе бесталанной и скучной, можно указать на это в обратной связи, чтобы автор поплакал над своим писательским навыком. Также можно пропускать введение в каждом задании и фокусироваться только на содержательной части.

## Chapter II
### Основы сетей. Часть 3

Настройка сетевого оборудования не заканчивается на настройке адресов и обеспечении возможности успешного подключения. К сожалению, существует очень много «подводных камней», которые обязательно нужно учитывать при построении сети. В их число входят и образующиеся «петли», и коллизия адресов, и необходимость масштабировать сеть в дальнейшем. Тебе повезло, что вендоры сетевого оборудования, включая Cisco, позаботились о том, чтобы реализовать механизмы защиты от этих камней. Осталось только научиться применять эти инструменты.

Зачастую ты не встретишься с необходимостью настраивать эти механизмы и протоколы при работе, но многие продвинутые атаки завязаны на эксплуатации мисконфигов при настройке VLAN, OSPF или STP, поэтому тебе обязательно надо знать, как они работают изнутри. И нет ничего лучше, чем самостоятельно построить «машину», а потом залезть к ней «под капот».

Для более глубокого понимания темы рекомендуем всё те же ресурсы:
- CBT Nuggets или их аналоги;
- Руководство по проектированию OSPF: https://www.justogroup.ru/dokumentacija/cisco/marshrutiziruemye_seti/rukovodstvo_po_proektirovaniyu_ospf.pdf;
- Отличная книга по BGP с примерами. Всё как мы любим: «Sam Halabi. Internet Routing Architectures»;
- Базовая книга «обо всем» от звездного автора: «Radia Perlman. Interconnections: Bridges, Routers, Switches, and Internetworking Protocols».

## Chapter III
### Задание 1. Виртуальные сети
Для решения данного задания нужны знания в следующих темах: VLAN, 802.1q, канальный уровень OSI, сетевой уровень OSI, коммутатор.

>Дело действительно оказалось нетривиальным. Улик было много, но все они никак не связывались друг с другом, будто были из разных мест, разного времени и разных преступлений. Иван уже несколько часов рассматривал собранные улики в участке, изрисовал всю доску стрелками, но так и не смог выйти на след преступника. Его напарник в это время мирно спал на кресле, измазавшись маркерами.
>
>— Ладно, нужен перекур, чашка кофе и немного свежего воздуха, — подумал Иван, отодвигаясь от стола.
>
>Действовать нужно было быстро, пока преступник не скрылся в каком-нибудь городе-миллионнике, где достать его будет практически невозможно. Это сильно нервировало детектива, и все его мысли были заняты работой. Выйдя на улицу, он по обыкновению прижался к стене и попытался отвлечься. Благо рядом курил его бывший напарник — Артем.
>
>То ли пытаясь найти поддержку, то ли просто от желания общаться, Иван рассказал ему детали дела, попутно вновь связывая все детали в одну цепочку. Артем, на удивление, слушал внимательно, не отрываясь, будто действительно хотел помочь Ивану раскрыть дело. Он медленно, но верно начал связывать две очень важные улики...

VLAN (Virtual LAN) — это технология, которая позволяет разделять сеть на подсети с помощью механизмов тегирования трафика. При этом без привязки к физической топологии. Этот механизм применяется повсеместно и помогает компаниям соединять в одну сеть несколько отделов или даже несколько офисов. В фундаменте лежит открытый стандарт 802.1q, который описывает, как нужно тегировать трафик. По сути, происходит добавление информации о теге в каждый пакет, а затем коммутатор проверяет по своим правилам, может ли данный тег быть отправлен к другому устройству. Примечательно, что, поскольку происходит добавление, а не изменение байтов пакета, обычные коммутаторы без механизма VLAN могут пропускать тегированные пакеты, просто не обращая внимание на встроенные теги.

Однако популярность этого механизма не могла пройти бесследно — существует достаточно большое количество кибератак, которые пользуются особенностями работы VLAN. С практической точки зрения понимание механизма VLAN помогает не только грамотно выстраивать сеть, используя при этом меньше ресурсов, но и в дальнейшем предотвращать такие атаки, как VLAN Hopping.

**Твоя задача**: построй сеть из 2 коммутаторов и 4 виртуальных компьютеров в GNS3:
- К первому коммутатору (SW1) должны быть подключены 2 виртуальных компьютера (PC1 и PC2).
- Ко второму коммутатору (SW2) должны быть подключены 2 виртуальных компьютера (PC3 и PC4).
- Организуй Trunk-соединение таким образом, чтобы PC1 и PC3 были в одном VLAN под номером 10, а PC2 и PC4 — в другом под номером 20.
- Укажи текстом IP-адреса виртуальных компьютеров вместе с маской рядом с их иконками в проекте.

Внимание! Для этого задания используй ранее скачанный образ Cisco 3745. Его можно использовать в качестве Ether Switch (лучше загуглить, как это сделать).

Итого у тебя должен быть файл с расширением .gns3 с настроенным Trunk-соединением.

### Задание 2. Расширение канала
Для решения данного задания нужны знания в следующих темах: канальный уровень OSI, etherchannel, сетевые порты и интерфейсы.

>— Тема, ты гений! — завопил Иван и потащил его в кабинет. — Нужно только изучить несколько дополнительных деталей, которые не позволяют собрать полную картину.
>
>С этими словами они вернулись в офис, конечно же, разбудив напарника Ивана от глубокого сна. Началась суета, маркеры вновь зацарапали доску, а в воздухе начал витать запах премии. Еще раз взглянув на все улики и составив ретроспективную цепочку событий, им удалось сагрегировать связи между всеми вещдоками и показаниями свидетелей, чтобы в конце концов выйти на след преступника...

Ты наверняка замечал, что иногда домашний Wi-Fi начинает «тупить». Или в кафе, когда набирается много посетителей, интернет значительно медленнее загружает видео с «Ютуба». С одной стороны, это может быть проблема на уровне роутера или провайдера, однако вариант перегрузки канала никогда нельзя исключать. Механизм etherchannel, используемый в Cisco, позволяет расширять канал взаимодействия между оборудованием, просто собирая в группу несколько интерфейсов. Таким образом, твое оборудование будет использовать 2–3–4 физических интерфейса для обеспечения одного канала (например, между двумя роутерами). Это позволяет, во-первых, обеспечить бесперебойную работу сети, ведь даже если один из интерфейсов выйдет из строя — всегда есть остальные. Во-вторых, пропускная способность такого канала значительно больше.

Определить использование etherchannel, не подключаясь к консоли оборудования, практически невозможно. Но всегда можно с умным видом сказать: «В этом заведении, судя по всему, используется агрегирование интерфейсов, поэтому здесь такой хороший Wi-Fi», вызвав уважение и трепет у окружающих.

**Твоя задача**: используй предыдущий проект за основу. Реализуй etherchannel через агрегирование интерфейсов таким образом, чтобы канал trunk состоял из двух физических портов на каждом из коммутаторов. Получившийся проект с расширением .gns3 и будет твоим решением.

В результате у тебя должна быть та же топология, что и в прошлом задании, но с агрегированными интерфейсами на коммутаторах.

### Задание 3. Динамическая маршрутизация
Для решения данного задания нужны знания в следующих темах: динамическая маршрутизация, статическая маршрутизация, алгоритм Дейкстры, IP-адресация, сетевой уровень OSI.

>Следующее утро детективы встретили в машине. Они разъезжали по городу, опрашивали всех знакомых подозреваемого и занимались наведением справок. Соседи подтвердили, что преступник отсутствовал в злополучную ночь. Иван не мог скрыть своей радости, постоянно что-то напевал и в целом был в хорошем расположении духа, несмотря на практически полное отсутствие сна. Теперь доказательств было достаточно, чтобы провести обыск в доме подозреваемого.

Динамическая маршрутизация — краеугольный камень всего интернета. В эти слова заложены несколько десятков алгоритмов и математических дисциплин, которые позволили реализовать данную технологию. Именно благодаря OSPF, BGP и другим ты сейчас читаешь этот текст и радуешься очередному практическому заданию.

OSPF работает по принципу «знай наших», т. е. маршрутизаторы опрашивают другие сетевые оборудования, чтобы построить с ними взаимодействие и не привязываться к статическим маршрутам. Таким образом создается своего рода зона (area), в которой маршрутизаторы присматривают друг за другом. Для всех очевидно, что не существует сетевого оборудования, которое может работать вечно — рано или поздно оно сломается / станет часто терять кадры / перегорит проводка / сисадмин спишет в утиль, а сам заберет к себе домой и продаст на «Авито» (нужное подчеркнуть). Особенно это актуально в сетях с огромным количеством трафика. OSPF позволяет купировать эти риски, поскольку любое вышедшее оборудование моментально «выключается» из маршрута, а на его место встает ранее включенное в сеть.

При этом OSPF — протокол внутренней динамической маршрутизации, а BGP уже относится к внешним и работает с группами маршрутизаторов. Рекомендуем почитать про BGP.

Помимо протоколов динамической маршрутизации, умные инженеры придумали протоколы устранения неполадок внутри сети. Например, протокол STP, который помогает избежать «петель» в сети — это когда пакет вместо маршрута «отправитель» -> «получатель» начинает следовать маршруту «отправитель» -> «сетевое оборудование» -> «сетевое оборудование» — и так до бесконечности. Рекомендуем почитать про реализацию протокола STP, а также про алгоритм, лежащий в его основе.

Интересный факт: алгоритм STP для протокола STP разработала женщина, которая впоследствии написала много книжек по сетям, одна из которых была рекомендована в самом начале этого проекта.

**Твое задание**: создай три маршрутизатора. R1 соединен с R2, R2 соединен с R3. R1 и R3 имеют по одной свободной подсети (к которой никто не подключен). Итого у тебя должно получиться 4 подсети (2 из них — между маршрутизаторами R1-R2 и R2-R3). Реализуй OSPF между всеми маршрутизаторами таким образом, чтобы с R3 можно было послать ping на интерфейс свободной подсети R1 и обратно. Например: свободный интерфейс R1: 192.168.1.1, свободный интерфейс R3: 192.168.3.1, пинг с R1 на 192.168.3.1 должен проходить и пинг с R3 на 192.168.1.1 должен проходить.

В качестве решения выложи файл проекта с расширением .gns3.

### Задание 4. Резервирование
Для решения данного задания нужны знания в следующих темах: HSRP, VRRP, NAT, IP-адресация, сетевой уровень OSI.

>На лестничном пролете было тесновато. Иван чуть ли не в обнимку стоял с полицейскими перед входной дверью — пролет явно не был рассчитан на такое количество человек. Проникновение в квартиру было стремительным, как и разочарование детектива, поскольку никого дома не оказалось, за исключением волнистого попугая в клетке. Иван вместе с коллегами по опасному бизнесу принялся бродить по небольшим комнатам и изучать быт незнакомого ему человека, каждый раз делая фотографии какой-нибудь безделушки. Всего через 10 минут активных поисков один из полицейских окликнул Ивана с помощником.
>
>В тумбе около кровати лежал дневник, в котором нервной рукой было написано чистосердечное признание в содеянном, извинения перед всеми пострадавшими и просьба позаботиться о попугае, который до этого самого момента пребывал в неподдельном шоке от всего происходящего и внимательно наблюдал за вторгнувшейся группой людей.
>
>Работа Ивана на этом была закончена. Он даже немного разочаровался, ведь обычно его рутина состояла из поисков украденного пирожка или очередного выслеживания пропавшего питомца, а в последние несколько дней работа доставляла ему одно удовольствие. «Ладно, еще месяцок поработаю и точно уволюсь», — подумал детектив.

HSRP — это протокол маршрутизации, разработанный и используемый Cisco для механизма резервирования. Его аналог — VRRP, который, в свою очередь, является открытым протоколом, выполняет ту же роль. Основной идеей является выделение виртуального адреса, за которым на самом деле скрываются несколько маршрутизаторов со своими адресами. Только обработка пакетов происходит не параллельно, а по принципу «работает сильнейший». В нашем случае — «работает тот, у кого выше приоритет». Для реализации резервирования необходимо минимум 2 маршрутизатора: один «Standby», а второй «Active» — он и выполняет всю работу по умолчанию. В случае выхода из строя активного маршрутизатора, вместо него автоматически начинает работать второй и дальше по списку, в зависимости от количества маршрутизаторов в HSRP-группе (так называются все маршрутизаторы, скрытые за виртуальным адресом).

В чем же разница между OSPF, спросишь ты? Разница в том, что группа HSRP не меняет своих адресов, а сам маршрут для всех участников остается неизменным (они не знают, что за виртуальным адресом скрывается несколько устройств), тем самым не происходит изменение таблицы маршрутизации. Своего рода NAT на минималках.

Практическое использование довольно ситуативно, но при встрече с HSRP можно натворить много дел по незнанию. Например, в рамках кибератаки злоумышленник на потеху группе реагирования и мониторинга может ломать маршрутизатор, который находится в режиме Standby и на данный момент не участвует в маршрутизации.

**Твое задание**: создай 2 маршрутизатора R1 и R2, которые соединены с коммутатором (на этот раз коммутатор может быть обычным Switch, не Cisco). А к коммутатору подключи виртуальный компьютер. На обоих маршрутизаторах должен быть реализован HSRP. R1, R2 и виртуальный компьютер должны находиться в одной подсети.

В результате своей работы сохрани данный проект с расширением .gns3.

💡 Нажми [сюда](https://new.oprosso.net/p/4cb31ec3f47a4596bc758ea1861fb624), чтобы поделиться с нами обратной связью на этот проект. Это анонимно и поможет команде Продукта сделать твоё обучение лучше.
