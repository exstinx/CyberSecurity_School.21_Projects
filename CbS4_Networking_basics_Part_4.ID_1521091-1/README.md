# Основы сетей. Часть 4 — «Стальная кошка»
Аннотация: в этом проекте тебе предстоит исследовать содержимое пакетов в дампах WireShark и tcpdump, reverse shell, а также автоматизировать и сформировать произвольные пакеты в scapy.


## Содержание
1. [Chapter I](#chapter-i) \
   1.1. [Рекомендации к проекту](#рекомендации-к-проекту)
2. [Chapter II](#chapter-ii) \
   2.1. [Анализ трафика](#анализ-трафика)
3. [Chapter III](#chapter-iii) \
   3.1. [Задание 1. Исследование сетевых пакетов](#задание-1-исследование-сетевых-пакетов)  
   3.2. [Задание 2. Поиск следов reverse shell](#задание-2-поиск-следов-reverse-shell)  
   3.3. [Задание 3. Использование scapy](#задание-3-использование-scapy) 
  

## Введение
>Капитан Элис Гаррисон — инженер по сетевой безопасности космической станции «Стальная кошка». Её путь в галактический корпус начался на планете Орион-7, где она выросла в тени гигантских космических антенн. Её родители работали на крупнейшей в секторе станции связи, и с ранних лет Элис впитала любовь к технологиям. На «Стальную кошку» она попала по распределению. Обещали много квант-долларов и вкусный кофе из галактических осьминогов, поэтому Элис обрадовалась и принялась штудировать учебники по межпланетной связи. Спустя 10 лет она дослужилась до звания капитана и была уже не той молодой студенткой, которая впервые увидела адскую разводку проводов в серверной.

## Chapter I
### Рекомендации к проекту
Как учиться в «Школе 21»:  
- На протяжении всего курса ты будешь самостоятельно добывать информацию. Пользуйся всеми доступными средствами поиска информации, к примеру, Google и GigaChat. Будь внимателен к источникам информации: проверяй, думай, анализируй, сравнивай. 
- Взаимообучение (P2P, Peer-to-Peer) — это процесс, при котором учащиеся обмениваются знаниями и опытом, выступая одновременно в роли учителей и учеников. Этот подход позволяет учиться не только у преподавателя, но и друг у друга, что способствует более глубокому пониманию материала.
- Не стесняйся просить помощи: вокруг тебя такие же пиры, которые тоже проходят этот путь впервые. Не бойся откликаться на просьбы о помощи. Твой опыт ценен и полезен, смело делись им с другими участниками. 
- Не списывай, а если пользуешься помощью — всегда разбирайся до конца, почему, как и зачем. Иначе твое обучение не будет иметь никакого смысла. 
- Если ты на чем-то застрял и кажется, что ты уже все перепробовал, но все равно непонятно, куда идти, — просто передохни! Поверь, этот совет помогал многим экспертам по КБ в их работе. Проветрись, перезагрузи голову и, возможно, в следующий раз тебе наконец придет нужное решение!
- Важен не только результат обучения, но и сам процесс. Нужно не просто решить задачу, а понять, КАК ее решить.


Как работать с проектом: 
- Перед выполнением проект необходимо склонировать с GitLab в одноименный репозиторий.
- Все файлы с кодом необходимо создавать в папке `src` склонированного репозитория.
- После клонирования проекта необходимо создать ветку `develop` и вести разработку в ней. После этого пушить в GitLab также нужно ветку `develop`.
- В твоей директории не должно быть иных файлов, кроме тех, что обозначены в заданиях.
- На пути к мастерству в сфере кибербезопасности ты получаешь возможность быть частью поддерживающего и вдохновляющего сообщества «Школы 21» по Кибербезопасности. Присоединяйся в [RocketChat](https://rocketchat-student.21-school.ru/channel/cybersec_21), чтобы получать свежие анонсы от сообщества, а также вступай в [Telegram](https://t.me/+r5wufz8L3mUzOGUy) для коммуникации. 

Дисклеймер: 
- В целях геймификации обучения проект подается в формате истории, чтобы у тебя была возможность отвлечься от сложных заданий и тонны теории в гугле. Если придуманная история кажется тебе бесталанной и скучной, можно указать на это в обратной связи, чтобы автор поплакал над своим писательским навыком. Также можно пропускать введение в каждом задании и фокусироваться только на содержательной части.

## Chapter II
### Анализ трафика

Анализ трафика применяется достаточно часто не только в кибербезопасности, но и в целом в IT. Анализ подразумевает поиск информации в записанном трафике: аномалий, ошибок сети, вредоносных пакетов и атак. Для того чтобы заниматься подобными задачами, нужно понимать модели OSI и TCP/IP не просто на уровне теории, но и на практике, что называется, залезать под капот. Ты должен понимать разницу между big-endian и little-endian (так называемый интеловский порядок), знать, какие поля существуют у сетевых пакетов на разных уровнях, и еще много-много всего. Именно за этим мы здесь и собрались — решать сложные задачи.

Независимо от того, в какую область кибербезопасности тебя забросит судьба, эти знания помогут тебе лучше разбираться во всем, что связано с сетью. В реальности зачастую вместо тебя анализировать трафик будут специальные инструменты и продукты детектирования атак, но никогда не будет лишним понимать, как они работают.

Чтобы получше прочувствовать, каково это, попробуй взять книгу «Война и мир» и искать в ней все буквы «ё». Каждый раз, когда ее находишь, записывай в блокнот. Поздравляю! Теперь ты представляешь, как работают L2-аналитики в SOC (Security Operations Center). ~~На этом проект закончен.~~ Задания, которые ты встретишь в этом проекте, составлены по реальным кейсам, которые вполне можно встретить в реальной жизни.

Для более глубокого изучения данной темы рекомендую следующие ресурсы:
- Network Forensics, Ric Messier (книга написана для профессии «сетевой криминалист». Она достаточно узкоспециализированная, также присутствует много воды, но если данный проект тебя заинтересует с профессиональной точки зрения, то однозначно стоит ее прочитать).
- [Wireshark оф. документация](https://www.wireshark.org/docs/). Разработчики этого замечательного продукта сами записывают ролики о тонкостях работы со своим инструментом, составляют гайды и предоставляют примеры записанного трафика — очень полезно, если хочется расширить кругозор и посмотреть, как выглядит трафик с USB или Bluetooth.
- Можно поискать задания с CTF (Capture The Flag) Jeopardy. Там достаточно часто встречаются задания с поиском чего-либо в дампе. Это можно считать финальным этапом вашего знакомства с анализом трафика. Пример одного из таких заданий вместе с решением можно посмотреть [здесь](https://github.com/C3n7ral051nt4g3ncy/Wireshark-CTF-Writeup).

## Chapter III
### Задание 1. Исследование сетевых пакетов
Для решения данного задания нужны знания в следующих темах: Wireshark, OSI и TCP/IP модели, протоколы прикладного уровня, шестнадцатеричная система счисления, big-endian/little-endian.

Введение: 

>Однажды Элис обнаружила необычные сбои в сетевом узле станции. Она подключила свой анализатор, чтобы перехватить и декодировать сетевой трафик. На ее экран вывелись данные дампа.
>
>— Что-то не так, — пробормотала Элис, изучая пакеты с помощью инструмента под названием WireShark, похожего на древний стетоскоп.
>
>Данные из дампа были фрагментированы, но среди привычных пакетов ICMP и HTTP затесался странный зашифрованный поток. Каждая строка раскрывала обрывочные данные: неожиданные заголовки, странные порты. Она поняла, что этот поток может быть сигналом снаружи — кто-то пытался связаться с внутренней сетью станции. И этот «кто-то» явно не имел хороших побуждений.

Wireshark — это ПО для анализа трафика. Оно позволяет как записывать его, так и просматривать уже записанный. Используется достаточно часто, особенно когда нужно вручную посмотреть, что происходит в сети. Интерфейс достаточно загруженный, но [официальная документация](https://wiki.wireshark.org/) поможет разобраться.

В Wireshark можно увидеть разделение пакета на уровни по OSI. И даже посмотреть каждый флаг/значение внутри! Кроме того, в отдельном окне выводится шестнадцатеричное представление всего пакета. Перед тем как просматривать байты пакета, нужно изучить понятия big-endian и little-endian. Это правила передачи байт в протоколах (в прямом порядке или перевернутом). Например, 0x152f и 0x2f15 — это одно и то же сообщение, просто переданное в двух разных вариантах. Самое интересное начнется, когда ты узнаешь, что внутри одного пакета на разных уровнях может применяться как little-endian, так и big-endian. Не забывай про это при выполнении задания.

**Твоя задача**: составить отчет по исследованному трафику. В отчете должны быть следующие пункты:

1. Опиши общими словами, что происходит в этом дампе.
2. Какая версия SMB-диалекта использовалась в соединении.
3. Предоставь session ID установленного соединения.
4. Какая учетная запись участвовала в соединении.
5. Выпиши MAC-адреса действующих сторон.

В результате выполнения у тебя должны быть:
- Отчет с названием `report.docx`, в котором по пунктам отражены вышеописанные вопросы.

### Задание 2. Поиск следов reverse shell
Для решения данного задания нужны знания в следующих темах: reverse shell, структура сетевых пакетов, модель OSI и TCP/IP.

>Шел второй час изучения данной аномалии. Элис подозревала, что инородный захватчик уже давно закрепился в сети. Аномалия всё больше и больше влияла на корабль, все инженеры были подняты по тревоге и помогали капитану Гаррисон справиться с проблемой. Следы привели ее к Орион-7 — ее родной планете, на которой она выросла и которую не видела уже больше 10 лет. Неужели ее сопланетники в данный момент атаковали «Стальную кошку»?

Если у тебя есть понимание работы сети, то ты уже можешь вручную находить сетевые атаки в записанном трафике. Reverse shell не всегда является атакой, но в большинстве случаев это явно аномальная ситуация в сети. Более того, чаще всего такой трафик зашифрован. Практически ни один серьезный взлом не обходится без этой техники, поскольку злоумышленник почти всегда вынужден коммуницировать с захваченным устройством. Вся суть состоит в том, чтобы заставить «жертву» подключиться к атакующему. Это делается, например, при проведении эксплуатации. Таким образом, для средств защиты и мониторинга всё выглядит так, будто это «жертва» подключилась куда-то, а не на нее проводится атака. Но тебя ведь не проведешь, да?

**Твоя задача**: изучи предоставленный файл some_troubled_traffic.pcapng в папке `src` и найди в нем reverse shell. Создай файл `answers.txt` с ответами на следующие вопросы:
- С какого IP адреса инициировался reverse shell?
- На какой IP адрес был проброшен reverse shell?
- С помощью какого протокола был осуществлен reverse shell?
- Какие команды были переданы?

В результате выполнения у тебя должен быть:
- Файл `answers.txt` с ответами на поставленные вопросы.

### Задание 3. Использование scapy
Для решения данного задания нужны знания в следующих темах: Python, scapy, структура сетевого пакета, протокол TCP.

>В это время на планете Орион-7 межгалактический подросток Алексей заканчивал читать свою книгу по продвинутой радиоэлектронике. Мальчик был любознательным, обожал возиться с техникой, а потому имел дома целый арсенал из мини-тарелок для связи, спутниковых антенн и одноплатных компьютеров. С Алексеем жилое пространство делил его хомяк Пинки, которого частенько выпускали погулять по комнате, чтобы он окончательно не набрал лишний вес. Сегодня был именно такой день. Алексей не сразу заметил, что Пинки увлеченно нажимает лапками по клавиатуре, поэтому, когда услышал очередной *клац* пробела, невольно дернулся с места.
>
>Быстрым рывком мальчик добрался до клавиатуры, снял хомяка с нее и ужаснулся — на мониторе была открыта командная строка какого-то сервера, и Пинки был в одном шаге от полного удаления всей системы. В названии хоста была надпись Steel Cat — знаменитой межгалактической станции. Нервно сглотнув ком в горле и осознав всю сложность ситуации, Алексей принялся исправлять это страшное недоразумение, ведь садиться в межпланетную тюрьму он не планировал.

Поскольку ты уже знаком с программированием, погружение в язык Python мы пропустим. Основной фокус необходимо сместить на библиотеку scapy. В кибербезопасности вовсе не обязательным условием является знание продвинутых конструкций и мастерское владение программированием, однако базовые навыки значительно упрощают повседневные задачи, и язык Python подходит для этих задач отлично — он простой в изучении, работает на любой ОС, а также позволяет за считаные минуты автоматизировать какое-нибудь решение. В повседневной работе такие «мелкие» задачи появляются постоянно.

**Твоя задача**: напиши скрипт на Python, который отправляет на локальный порт 127.0.0.1:12345 по протоколу TCP сообщение с использованием scapy: «Dear Steel Cat! This is no attack, it's my humster Pinkie you should track». Перехвати это сообщение с помощью Wireshark и сделай дамп `sent_message.pcapng` в папке `src` только с одним этим сообщением.

Должно получиться следующее:
- Скрипт `main.py` с реализацией задания.
- Дамп `sent_message.pcapng` с единственным пакетом.

💡 Нажми [сюда](https://new.oprosso.net/p/4cb31ec3f47a4596bc758ea1861fb624), чтобы поделиться с нами обратной связью на этот проект. Это анонимно и поможет команде Продукта сделать твоё обучение лучше.
